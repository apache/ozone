---
- name: "Set replication factor"
  set_fact:
    create_key_cmd: "{{ 'sh key put --type RATIS --replication ONE' if groups.get('datanodes', []) | length < 3 else 'sh key put' }}"
    vol: "demovol"
    bucket: "demobuck"
    key: "demokey"
    ozone_bin: "{{ install_base }}/current/bin/ozone"

- name: "Print ozone command to create key based on Datanode count"
  debug:
    msg: "{{ create_key_cmd }}"

- name: "Run basic smoke commands"
  shell: |
    set -euo pipefail
    dd if=/dev/zero of=/tmp/oz_smoke.bin bs=1M count=1 status=none
    {{ ozone_bin }} sh vol create {{ vol }} || true
    {{ ozone_bin }} sh bucket create {{ vol }}/{{ bucket }} || true
    {{ ozone_bin }} {{ create_key_cmd }} {{ vol }}/{{ bucket }}/{{ key }} /tmp/oz_smoke.bin
    rm -f /tmp/oz_smoke.bin
  register: smoke_commands_result
  failed_when: smoke_commands_result.rc != 0
  run_once: true
  become: true
  become_user: "{{ service_user }}"

- name: "Verify key info"
  shell: |
    set -euo pipefail
    {{ ozone_bin }} sh key info {{ vol }}/{{ bucket }}/{{ key }}
  register: key_info
  failed_when: key_info.rc != 0
  run_once: true
  become: true
  become_user: "{{ service_user }}"

- name: "Show key info"
  debug:
    msg:
      - "Stdout: {{ (key_info.stdout_lines | default([])) | join('\n') }}"
      - "Stderr: {{ (key_info.stderr_lines | default([])) | join('\n') }}"
  run_once: true

