---
- name: "Set replication factor"
  set_fact:
    create_key_cmd: "{{ 'sh key put --type RATIS --replication ONE' if groups.get('datanodes', []) | length < 3 else 'sh key put' }}"
    vol: "demovol"
    bucket: "demobuck"
    s3g_bucket: "demos3g"
    key: "demokey"
    ozone_bin: "{{ install_base }}/current/bin/ozone"

- name: "Print ozone command to create key based on Datanode count"
  debug:
    msg: "{{ create_key_cmd }}"

- name: "Run basic smoke commands"
  shell: |
    set -euo pipefail
    dd if=/dev/zero of=/tmp/oz_smoke.bin bs=1M count=1 status=none
    {{ ozone_bin }} sh vol create {{ vol }} || true
    {{ ozone_bin }} sh bucket create {{ vol }}/{{ bucket }} || true
    {{ ozone_bin }} {{ create_key_cmd }} {{ vol }}/{{ bucket }}/{{ key }} /tmp/oz_smoke.bin
    rm -f /tmp/oz_smoke.bin
  register: smoke_commands_result
  failed_when: smoke_commands_result.rc != 0
  run_once: true
  become: true
  become_user: "{{ service_user }}"

- name: "Verify key info"
  shell: |
    set -euo pipefail
    {{ ozone_bin }} sh key info {{ vol }}/{{ bucket }}/{{ key }}
  register: key_info
  failed_when: key_info.rc != 0
  run_once: true
  become: true
  become_user: "{{ service_user }}"

- name: "Show key info"
  debug:
    msg:
      - "Stdout: {{ (key_info.stdout_lines | default([])) | join('\n') }}"
      - "Stderr: {{ (key_info.stderr_lines | default([])) | join('\n') }}"
  run_once: true

- name: "Create test bucket on S3G host (if present)"
  block:
    - name: "Install awscli on S3G host"
      package:
        name: awscli
        state: present
      become: true

    - name: "AWS CLI configure dummy credentials for S3G tests"
      shell: |
        set -euo pipefail
        aws configure set aws_access_key_id dummy
        aws configure set aws_secret_access_key dummy

    - name: "AWS CLI S3G: create test bucket '{{ s3g_bucket }}'"
      shell: |
        set -o pipefail
        aws s3api create-bucket --bucket {{ s3g_bucket }} --endpoint-url "http://{{ groups['s3g'][0] }}:9878" || true
      args:
        executable: /bin/bash
      register: aws_create_result
      changed_when: false

    - name: "AWS CLI S3G: list buckets"
      shell: |
        set -o pipefail
        aws s3api list-buckets --endpoint-url "http://{{ groups['s3g'][0] }}:9878"
      args:
        executable: /bin/bash
      register: aws_list_result
      changed_when: false

    - name: "Show AWS CLI S3G check output"
      debug:
        msg:
          - "Create bucket output: {{ (aws_create_result.stdout | default('')) }}"
          - "List buckets output: {{ (aws_list_result.stdout | default('')) }}"
  when:
    - groups.get('s3g', []) | length > 0
    - inventory_hostname == groups['s3g'][0]